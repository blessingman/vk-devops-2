
# ClickHouse Kubernetes Deployment

–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ä–µ—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º—É —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ClickHouse –≤ Kubernetes —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Helm.

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è

–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –±—ã–ª —Å–æ–∑–¥–∞–Ω Helm-—á–∞—Ä—Ç, —Å–æ—Å—Ç–æ—è—â–∏–π –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

1.  **StatefulSet (`statefulset.yaml`)**:
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ `Deployment`, —Ç–∞–∫ –∫–∞–∫ ClickHouse ‚Äî —ç—Ç–æ stateful-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö).
    *   –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã.
    *   –°–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –∑–∞–ø—É—Å–∫ 1 —Ä–µ–ø–ª–∏–∫–∏ (—Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –æ single-–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏–∏).
    *   –°–æ–¥–µ—Ä–∂–∏—Ç Liveness Probe –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î (`/ping`).

2.  **ConfigMap (`configmap.yaml`)**:
    *   –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ñ–∞–π–ª–∞ `users.xml`.
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —à–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—Ä Helm –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`<users>`) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞, –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ –≤ `values.yaml`.
    *   –ú–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `/etc/clickhouse-server/users.d/`, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç ClickHouse –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞.

3.  **Service (`service.yaml`)**:
    *   –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–¥–∞–º –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ (ClusterIP).
    *   –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã: `8123` (HTTP) –∏ `9000` (Native TCP).

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∑–∞–¥–∞–Ω–∏—è

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
| :--- | :--- |
| **1. Single-–∏–Ω—Å—Ç–∞–ª–ª—è—Ü–∏—è** | –í `StatefulSet` –∂–µ—Å—Ç–∫–æ –∑–∞–¥–∞–Ω–æ `replicas: 1`. |
| **2. –£–∫–∞–∑–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–∏** | –í–µ—Ä—Å–∏—è –æ–±—Ä–∞–∑–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `image.tag` –≤ —Ñ–∞–π–ª–µ `values.yaml`. –ï—ë –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ. |
| **3. –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** | –í `values.yaml` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –º–∞—Å—Å–∏–≤ `dbUsers`. –®–∞–±–ª–æ–Ω `configmap.yaml` –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ —ç—Ç–æ–º—É –º–∞—Å—Å–∏–≤—É —Ü–∏–∫–ª–æ–º –∏ —Å–æ–∑–¥–∞–µ—Ç XML-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. |
| **4. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ README** | –ö–æ–¥ —á–∞—Ä—Ç–∞ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –¥–∞–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–ª–∞–≥–∞–µ—Ç—Å—è. |

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
*   –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `helm`
*   –î–æ—Å—Ç—É–ø –∫ –∫–ª–∞—Å—Ç–µ—Ä—É Kubernetes (–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π Minikube)

### 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤–µ—Ä—Å–∏—è 23.8, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏):

```bash
helm install clickhouse-release ./charts
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –≤–µ—Ä—Å–∏–∏ (–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 2)
–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ ClickHouse (–Ω–∞–ø—Ä–∏–º–µ—Ä, `23.3`) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ `--set`:

```bash
helm install clickhouse-v23 ./charts --set image.tag="23.3"
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 3)
–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å —Å–≤–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä—è–º–æ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É:

```bash
helm install clickhouse-users ./charts \
  --set dbUsers[0].username="devops" \
  --set dbUsers[0].password="securePass" \
  --set dbUsers[0].networks.ip="::/0"
```

## ‚öôÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
.
‚îú‚îÄ‚îÄ README.md          # –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è
‚îî‚îÄ‚îÄ charts/            # Helm-—á–∞—Ä—Ç
    ‚îú‚îÄ‚îÄ Chart.yaml     # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞—Ä—Ç–∞
    ‚îú‚îÄ‚îÄ values.yaml    # –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    ‚îî‚îÄ‚îÄ templates/     # –®–∞–±–ª–æ–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
        ‚îú‚îÄ‚îÄ configmap.yaml   # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        ‚îú‚îÄ‚îÄ service.yaml     # –°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø
        ‚îî‚îÄ‚îÄ statefulset.yaml # –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥–∞ –ë–î
```